// Add steps as necessary for accessing the software, post-configuration, and testing. Don't include full usage instructions for your software, but add links to your product documentation for that information.
//Should any sections not be applicable, remove them

//== Test the deployment
// If steps are required to test the deployment, add them here. If not, remove the heading

== Post-deployment steps

:xrefstyle: short

// If Post-deployment steps are required, add them here. If not, remove the heading


//Reference post-deployment.adoc file
include::./post_deployment.adoc[]

The configuration steps you follow after deploying this Quick Start depend on which deployment option you chose. Follow the steps documented in the appropriate user guide. Download here:

* https://github.com/aws-quickstart/quickstart-aws-industrial-machine-connectivity/raw/master/documentation/IMC%20-%20Virtual%20Deployment%20User%20Guide.docx[IMC Virtual Deployment User Guide]
* https://github.com/aws-quickstart/quickstart-aws-industrial-machine-connectivity/raw/master/documentation/IMC%20-%20Physical-Greenfield%20Deployment%20User%20Guide.docx[IMC Physical-Greenfield Deployment User Guide]
* https://github.com/aws-quickstart/quickstart-aws-industrial-machine-connectivity/raw/master/documentation/IMC%20-%20Physical-Brownfield%20Deployment%20User%20Guide.docx[Physical-Brownfield Deployment User Guide]

//TODO Shivansh, Do people still need these user guides? From a quick scan of the Word docs, it looks like they cover a lot of info similar to this deployment guide. Maybe those guides become obsolete now? (If we're keeping these guides, please clarify the relationship between them and this deployment guide.)

//TODO Shivansh, Note that the URLs above have "master" in them. That needs to change when we update the GitHub "master" reference.

//== Best practices for using the {partner-product-short-name} Quick Start on AWS
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

//_Add any best practices for using the software._

//== Security
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

//_Add any security-related information._

== Other useful information
//Provide any other information of interest to users, especially focusing on areas where AWS or cloud usage differs from on-premises usage.

//_Add any other details that will help the customer use the software on AWS._

=== External documents

* Guide for creating AMC drivers (link to external document)
* AMC approved DyanamoDB table format (link to external document)
* Adding a line and device to an Ignition project (link to external document)
* Extending or modifying the {partner-product-short-name} Quick Start with new features and capabilities (link to external document)

//TODO Shivansh, What are the URLs for the links above? 

//TODO Shivansh, What are the titles of the four docs exactly as they appear in those docs?

=== Asset Model Converter

The Asset Model Converter (AMC) code is in two separate Lambda functions located in the functions or source directory of the repository.

* AssetModelIngestion. This is the ingestion Lambda function. Its purpose is to listen to MQTT messages coming from the CirusLink Ignition module and put them into the incoming S3 bucket as objects. The relevant handler file is `assetModelIngestion.py`. 
* AssetModelConverter. The AMC covers two functions: AMC1 and AMC2. 
** AMC1 
*** This code is initiated by an Amazon S3 object creation from the incoming bucket. It has its reserved concurrent executions set to 1 to make sure that only a single instance of Lambda can ever fire at the same time. This has been done because the Ignition Cirrus Link module can birth the asset structure as multiple discrete MQTT messages, each of which becomes a file object in Amazon S3.
*** The core logic of the AMC1 comes in the form of the main handler file, `assetModelConverter.py`. It contains the base Lambda handler function, which in turn calls in to the AssetModelConverter class to handle a given S3 object-creation event. This code in turn calls the relevant driver code to handle the asset structure files.
*** AMC drivers in AMC1 are responsible for parsing the incoming asset structure files and converting them into a normalized format that is then stored into DynamoDB. See the "Creating AMC Drivers" section of the Getting Started guide for more details on creating drivers and the DynamoDB normalized format.
//TODO Shivansh, What is this Getting Started guide (above)? How do people find it?
** AMC2
*** This relevant code file here is `createSitewiseResources.py`. This contains code to take the normalized DynamoDB format, and create relevant AWS IoT SiteWise assets and models from that format. Changes are marked in the DynamoDB table to various assets or models that require updates or creation.
*** All AWS IoT SiteWise interactions take place in the `sitewiseUtils.py` code. 
*** Only additive changes are supported.
*** The AMC2 process:
. Model creation. The DynamoDB models table is queried to look for models that require creation. Those are created in AWS IoT SiteWise.
. Asset creation. The DynamoDB assets table is also queried, looking for records that are marked as needing creation. Those assets, instances of the models created during model creation, are then created in AWS IoT SiteWise.
. Model hierarchies. In this step, models are associated with each other in a hierarchy and tagged as having a parent-child relationship.
. Asset associations. Similarly, in this final step, assets that are tagged as having a parent-child relationship are associated with each other.

=== Creating AMC drivers

. Write the driver that interprets the incoming hierarchy data from your edge-based asset modeling software and converts it into the AMC-approved format (see the format here) and puts it into DynamoDB.

//TODO Shivansh, In the previous sentence, what does "format here" refer to ... a downloadable file? ... a web page?

//TODO Shivansh, What's the URL for that "format here" link?

.. Refer to the template file for guidance while writing your driver:
... `/functions/source/AssetModelConverter/drivers/example_driver_template.py`
.. ** Highly recommended â€“ also refer to the existing drivers: 
... `/functions/source/AssetModelConverter/drivers/igniitonCirrusLinkDriver.py`
... `/functions/source/AssetModelConverter/drivers/ignitionFileDriver.py`
... `/functions/source/AssetModelConverter/drivers/kepserver_file_driver.py`
. Edit the entry point file for the AMC (`/functions/source/AssetModelConverter/assetModelConverter.py`) to use your new driver:
.. Import your driver with import statement (replacing the information in brackets):
... `From drivers.<name_of_file> import <name_of_driver_class>`
.. Add your driver to the 'driverTable' list.
... `<name_of_driver>:<name_of_driver_class>`
. Replace the AssetModelConverter zip file with its new contents:
.. Zip up the contents of `/functions/source/AssetModelConverter/`
.. Name the .zip file `AssetModelConverter.zip`.
.. Replace the old `AssetModelConverter.zip` file (`/functions/packages/AssetModelConverter/AssetModelConverter.zip`) with the new `AssetModelConverter.zip` file you created. 
. Edit the AWS CloudFormation template to include your driver's name: 
.. `/templates/IMC-workload.template.yaml`
... Add an item to the list of AMCDrivers (parameter section):
.... `<name_of_driver>`

//TODO Shivansh, What is the numbering supposed to be in the steps above? I gave up trying to interpret it. :)

=== Artifacts

The following directories and files are necessary for running an {partner-product-short-name} Quick Start deployment: 

    functions/
    scripts/
    templates/
    LICENSE.txt
    NOTICE.txt
    README.md

* *quickstart-IMC/*: The root directory in the S3 bucket, where the rest of the directories live.
* *functions/*: Contains zipped Lambda code that is used for various pieces of the {partner-product-short-name} Quick Start.
* *scripts/*: Contains the scripts that are run on physical hardware if running a physical deployment.
* *templates/*: Contains the various AWS CloudFormation templates that are deployed depending on the deployment options selected during stack creation.

=== AMC-approved DynamoDB format

Asset mModel table name:
 
 <name-of-stack>-asset-model-table

Example of asset model entry:
....
assetModelEntry = {
    "assetModelName": type<string>, # Name of the asset model
    "parent": type<string>, # name of the parent asset model, if any
    "assetModelProperties": type<list<modelProperty>>, # list of sitewise assetModelProperties as 'modelProperty' listed below.
    "assetModelHierarchies": type<list>, # sitewise assetModelHierarchies, leave blank []
    "change": type<string>, # Should be 'YES', indicates in DynamoDB that the record is new or updated.
}
    modelProperty = {
        'name': type<string>, # Name of the property
        'dataType': type<string>, # Sitewise data type of the property
        'type': {
            'measurement': {} # Don't change this or populate it with anything, used to identify property type in sitewise
        }
    }
....

Asset table name:

 <name-of-stack>-asset-table

Example of asset entry:

....
assetEntry = {
    'assetName': type<string>, # name of the asset
    'modelName': type<string>, # model name this asset is an instance of
    'change': type<string>, # Should be 'YES', indicates in DynamoDB that the record is new or updated.
    'tags': type<list<tagEntry>>, # List of tagEntry struct, as specified below
}    tagEntry = {
        'tagName': type<string>, # name of the tag
        'tagPath': type<string>, # Full property alias path for the tag
    }
....


=== Add a line and device to an Ignition project

. Navigate to Ignition Designer and connect to your Ignition server.
.. Launch Ignition Designer.
.. Choose *Add Designer*. 
.. Choose *Manually Add Gateway*.
.. Add a gateway URL in the following format (replacing the information in brackets): `http://<ignition_ec2_public_ip>:8088`
.. Under the gateway tile you just added, choose *Launch*. 
.. Supply the user name and password, and choose *Login*.
... User name: admin
... Password: password
... If you haven't already, change your password after you've logged into the Ignition web UI.
. Create a data type.
.. Navigate to the *Tag Browser*, expand *Tags*, open the context (right-click) *Data Types* menu, and choose *New Tag*, *New Data Type*.
.. Under *Properties*, name the data type *Pump*, and choose *Apply*.
. Configure the tags for the data type.
.. Tag 1: Temperature
.. To the left of the *Properties* section, choose the *Add Tag* button, and choose *OPC Tag*: 

.Ignition Designerâ€”Add tag
[link=images/IgnitionAddTag.png]
image::../images/IgnitionAddTag.png[Ignition add tag]

Next, edit the basic properties of the tag:

. Name the tag *Temperature*.
. Change its data type to *float*. 
. Choose the *Link* icon to the right of *OPC Server*, choose *Browse OPC*, open the context (right-click) the *Ignition OPC UA Server* menu, choose *Copy Item Path*, and choose *Commit*.
. Right-click in the space to the right of *OPC Server*, and paste what's copied in your clipboard.
. Choose the *Link* icon to the right of *OPC Item Path*, choose *Browse OPC*, expand *Ignition OPC UA Server*, expand *Devices*, expand simulation, *Line 1*, *Conveyor*. Highlight *Temperature*, and choose *Commit*. 
. Verify that your tag configuration looks similar to <<ignition-tag-config>>.
. Choose *Apply* and *OK* to accept the tag configuration.

[#ignition-tag-config]
.Ignition Designerâ€”Configure tag
[link=images/IgnitionTagConfiguration.png]
image::../images/IgnitionTagConfiguration.png[Configure tag]

Create a second tag to represent pressure.

. To the left of the *Properties* section, choose the *Add Tag* button, and choose *OPC Tag*. 
. Edit the basic properties. 
.. Name the tag *Pressure*.
.. Change its data type to *float*. 
.. Choose the *Link* icon to the right of *OPC Server*, choose *Browse OPC*, open the context (right-click) *Ignition OPC UA Server* menu, choose *Copy Item Path*, and choose *Commit*. Right-click in the space to the right of *OPC Server* and paste what's copied in your clipboard.
.. Choose the *Link* icon to the right of *OPC Item Path*, choose *Browse OPC*, expand *Ignition OPC UA Server*, expand *Devices*, expand simulation, expand *Line 1*, expand *Stamping Machine*. Highlight *Pressure*, and choose *Commit*. 
.. Choose *Apply* and *OK* to accept the tag configuration.

Create a third tag to represent vibration.

. To the left of the *Properties* section, choose the *Add Tag* button, and choose *OPC Tag*. 
. Edit the basic properties. 
.. Name the tag *Vibration*.
.. Change its data type to *float*. 
.. Choose the *Link* icon to the right of *OPC Server*, choose *Browse OPC*, open the context (right-click) *Ignition OPC UA Server* menu, choose *Copy Item Path*, and choose *Commit*. Right-click in the space to the right of *OPC Server* and paste what's copied in your clipboard.
.. Choose the *Link* icon to the right of *OPC Item Path*, choose *Browse OPC*, expand *Ignition OPC UA Server*, expand *Devices*, expand simulation, expand *Line 1*, expand *Conveyor*. Highlight *Vibration*, and choose *Commit*. 
.. Choose *Apply* and *OK* to accept the pump configuration.

When you're finished adding all your tags, the pump should look as shown in <<pulp-tag-structure>>:

[#pulp-tag-structure]
.Ignition Designerâ€”Pump tag structure
[link=images/PumpTagStructure.png]
image::../images/PumpTagStructure.png[Pump tag structure]

Add the line to the project:

. Under the tag browser, expand *All Providers*. Choose the default, then choose *New Tag*, *New Folder*, *Line 4*. 
. Choose *New Tag*, *New Data Type Instance*, *Pump*.
.. Give the instance the name *Pump*. Choose *Apply*.
. Initiate a birth message:
.. Under the tag browser, expand *Tag Providers*, expand default, and expand *Sim Controls*. To the right of *New Birth*, and select the *Write Once* check box.

This initiates an MQTT message that defines your new hierarchy, with Line 4 and the pump included. Your new models and assets now appear in AWS IoT SiteWise.

=== Set up a QuickSight dashboard along with the {partner-product-short-name} Quick Start deployment

After the {partner-product-short-name} Quick Start deployment succeeds (models and assets have finished creation in AWS IoT SiteWise), the following manual steps are required to create a QuickSight dataset. 

. Allow QuickSight access to the S3 bucket that houses the data from the {partner-product-short-name} Quick Start. 
.. Choose *Manage QuickSight* from the top-right corner.

.QuickSightâ€”Manage QuickSight
[link=images/QSManageQS.png]
image::../images/QSManageQS.png[Manage QuickSight]

Choose *Security & permissions*. Under *QuickSight access to AWS services*, choose *Add or remove*.

.QuickSightâ€”Security and permissions
[link=images/QSSecurityAndPermissions.png]
image::../images/QSSecurityAndPermissions.png[Security and permissions]

Under *QuickSight access to AWS services*, select *Amazon S3*.

.QuickSightâ€”Access to AWS services
[link=images/QSAccessToServices.png]
image::../images/QSAccessToServices.png[Access to AWS services]

Find the S3 bucket labeled `<IMCQSDeploymentName>...-imcs3bucket-â€¦.`, select it, and choose *Finish*.

.QuickSightâ€”Select the S3 bucket
[link=images/QSSelectS3Bucket.png]
image::../images/QSSelectS3Bucket.png[Select S3 bucket]

Open the IoT console. Choose *Test* on the navigation bar. The MQTT client opens.

.AWS IoT Coreâ€”Test client
[link=images/QS-MQTT-Client.png]
image::../images/QS-MQTT-Client.png[Test client]

Initiate the creation of your QuickSight dataset by publishing an MQTT message to the MQTT topic: `imc/control/quicksight`. Enter anything; the content of your message is inconsequential.

.AWS IoT Coreâ€”MQTT publish message
[link=images/QS-MQTT-Publish.png]
image::../images/QS-MQTT-Publish.png[MQTT publish message]

After the message is published, a dataset called `imcDataSet` populates the QuickSight dataset dashboard. Click into the dataset to create a visualization analysis.

.QuickSight datasets
[link=images/QS-Datasets.png]
image::../images/QS-Datasets.png[QuickSight datasets]

Now that you've created a dataset in QuickSight, you can create visualizations with the data. For details, see https://docs.aws.amazon.com/quicksight/latest/user/welcome.html[What Is Amazon QuickSight?^]

=== Launch the AWS CloudFormation stack from your own S3 bucket

This section tells how to extend or modify the {partner-product-short-name} Quick Start with new features or capabilities. Here's the high-level process: clone the https://github.com/aws-quickstart/quickstart-aws-industrial-machine-connectivity[{partner-product-short-name} Quick Start repo^], create a new S3 bucket, and add the repo assets to that bucket. The following instructions detail the process:

. Create a new S3 bucket. and give it a unique name such as *imc-dev-123*.
. In that S3 bucket, create a directory called *quickstart-IMC*.
. Download the public {partner-product-short-name} Quick Start GitHub repo (https://github.com/aws-quickstart/quickstart-aws-industrial-machine-connectivity) as a zip file.
. Unzip the downloaded file, and copy all the contents of the unzipped folder (GitHub repo contents) into the *quickstart-IMC* directory in your S3 bucket. The structure then resembles the following structure:
.. S3 bucket name: `imc-dev-123`
.. S3 bucket content:

....
quickstart-IMC/
    	documentation/
functions/
    	scripts/
	submodules/
    	templates/
    	.gitignore
	.gitmodules
	.taskcat.yml
LICENSE.txt
    	NOTICE.txt
    	README.md
....